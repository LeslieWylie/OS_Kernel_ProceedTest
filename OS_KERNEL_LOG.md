# OS 内核开发日志

## 2023-06-15 - 进程管理系统构建

### 已完成工作

1. 搭建了基本的进程管理框架

   - 定义了进程控制块结构 `process_t`
   - 实现了进程创建和销毁功能
   - 添加了进程状态管理

2. 实现了上下文切换机制
   - 定义上下文结构 `context_t`
   - 实现基于内联汇编的上下文保存和恢复
   - 添加了汇编实现的低级上下文切换

### 遇到的问题

1. 上下文切换时寄存器保存不正确

   - **原因**: 在 `context_restore` 函数中，汇编约束设置不正确
   - **解决方案**: 将 `"r"` 约束改为 `"rm"` 允许更灵活的地址模式
   - **学习**: 在内联汇编中，正确的约束对于代码正常工作至关重要

2. 编译时 `process_t` 类型未定义
   - **原因**: 头文件包含顺序不正确或缺少必要头文件
   - **解决方案**: 确保在所有使用 `process_t` 的文件中都包含 `process.h`
   - **学习**: 头文件依赖关系需要明确，特别是在大型项目中

## 2023-06-18 - 调度器实现

### 已完成工作

1. 实现了基本的调度算法

   - FIFO (先进先出) 调度算法
   - SJF (最短作业优先) 调度算法

2. 添加了进程队列管理
   - 就绪队列
   - 阻塞队列

### 遇到的问题

1. 多重定义的 `schedule()` 函数

   - **原因**: 在 `process.c` 和 `scheduler.c` 中都定义了 `schedule()` 函数
   - **解决方案**: 将 `process.c` 中的 `schedule()` 重命名为 `schedule_sjf()`
   - **学习**: 在多文件项目中要避免函数名冲突

2. 进程切换时 `switch_to` 函数调用约定不一致
   - **原因**: `__switch_to` 的声明与实现不匹配
   - **解决方案**: 确保函数签名一致，并正确设置参数类型
   - **学习**: 汇编和 C 交互时需要确保调用约定一致

## 2023-06-20 - 内存管理和测试框架

### 已完成工作

1. 添加了简化的内存管理

   - 实现 `kmalloc`/`kfree` 函数
   - 添加内核栈分配和释放功能

2. 构建测试框架
   - 进程创建和终止测试
   - 调度器功能测试
   - 上下文切换测试

### 遇到的问题

1. 内存泄漏问题

   - **原因**: 进程终止时未正确释放所有资源
   - **解决方案**: 在 `process_exit` 中添加全面的资源清理
   - **学习**: 在资源分配和释放间需要保持平衡

2. 缺少 `stdlib.h` 导致的编译错误

   - **原因**: 测试代码中使用了 `malloc`/`free` 但未包含头文件
   - **解决方案**: 添加 `#include <stdlib.h>` 到测试文件
   - **学习**: 注意标准库函数的头文件依赖

3. `EOF;` 意外出现在代码中
   - **原因**: 可能是编辑器操作或复制粘贴错误
   - **解决方案**: 移除这个无效的标记
   - **学习**: 检查代码中的异常语法标记

## 2023-06-22 - 系统整合与文档

### 已完成工作

1. 整合各个子系统

   - 进程管理
   - 调度
   - 上下文切换
   - 内存管理

2. 编写文档

   - README.md
   - 使用教程
   - API 文档

3. 构建脚本改进
   - 创建统一的 Makefile
   - 添加测试命令

### 遇到的问题

1. 测试环境缺少 `printk` 函数

   - **原因**: 内核代码尝试使用 `printk` 但测试环境中不存在
   - **解决方案**: 在测试代码中添加 `printk` 实现，使用 `vprintf` 重定向输出
   - **学习**: 测试环境需要模拟内核环境中的特定函数

2. 构建系统路径问题
   - **原因**: 不同平台的路径分隔符和命令不同
   - **解决方案**: 使用相对路径和平台无关的 Makefile 语法
   - **学习**: 构建脚本需要考虑跨平台兼容性

## 2024-XX-XX 进程管理测试界面开发

### 添加的功能

1. **命令行测试界面**

   - 创建了`tests/process/process_cli.c`实现命令行界面
   - 支持以下命令：
     - `help` - 显示帮助信息
     - `init` - 初始化进程系统
     - `create <名称> <优先级>` - 创建普通进程
     - `create-long <名称> <优先级>` - 创建长时间运行的进程
     - `create-infinite <名称> <优先级>` - 创建无限循环的进程
     - `list` - 列出所有进程
     - `schedule` - 运行 FIFO 调度器
     - `schedule-sjf` - 运行 SJF 调度器
     - `kill <PID>` - 终止进程
     - `block <PID>` - 阻塞进程
     - `wake <PID>` - 唤醒进程

2. **进程工具函数**

   - 创建了`kernel/process/process_utils.c`实现辅助功能：
     - `process_state_to_string()` - 将进程状态转换为可读字符串
     - `process_is_alive()` - 检查进程是否存活
     - `process_set_state()` - 设置进程状态
     - `process_get_current()` - 获取当前进程
     - `process_set_current()` - 设置当前进程

3. **测试脚本**

   - 创建了`tests/process/run_tests.sh`和`tests/process/run_tests.bat`用于不同系统的测试启动
   - 实现了自动化测试能力

4. **编译系统**
   - 更新了`tests/process/Makefile`以支持测试编译
   - 添加了进程管理相关依赖

### 开发思路

1. **测试界面设计**

   - 采用了简单的命令行解析方式
   - 实现了易于理解的命令名称和参数
   - 提供了足够的反馈信息

2. **测试进程类型**

   - 短时间运行的进程：用于快速测试基本功能
   - 长时间运行的进程：用于测试调度行为
   - 无限循环的进程：用于测试进程阻塞和终止

3. **用户体验**
   - 每个命令提供清晰的用法说明
   - 命令执行后显示操作结果
   - 使用表格格式展示进程列表

### 后续改进计划

1. **添加更多测试场景**

   - 进程间通信测试
   - 资源竞争测试
   - 边界条件测试

2. **增强调试能力**

   - 添加详细的日志记录
   - 实现进程快照功能
   - 添加性能计数器

3. **GUI 界面**
   - 考虑开发图形化测试界面
   - 实现进程状态的可视化展示
   - 提供交互式调度控制

## 后续计划

1. 实现更多调度算法

   - 轮转调度 (Round Robin)
   - 多级反馈队列 (MLFQ)

2. 添加进程间通信机制

   - 共享内存
   - 消息队列
   - 信号量

3. 实现完整的内存管理

   - 虚拟内存支持
   - 页表管理
   - 内存映射

4. 添加用户态支持
   - 特权级切换
   - 系统调用接口
   - 用户态库
